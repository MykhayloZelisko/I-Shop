<div class="new-device">
  <div class="new-device__form" [formGroup]="newDeviceForm">
    <app-input
      [label]="'Назва товару'"
      [placeholder]="'Введіть назву товару'"
      [validators]="requiredValidators"
      formControlName="deviceName"
    ></app-input>
    <app-input
      [label]="'Ціна в гривнях'"
      [placeholder]="'Ціна в гривнях'"
      [validators]="priceCountValidators"
      [maskConfig]="priceMaskConfig"
      formControlName="price"
    ></app-input>
    <app-input
      [label]="'Кількість'"
      [placeholder]="'Кількість'"
      [validators]="priceCountValidators"
      [maskConfig]="countMaskConfig"
      formControlName="count"
    ></app-input>
    @if (brands$ | async; as brands) {
      <div class="new-device__field">
        <label class="new-device__label" for="brand-id">Бренд</label>
        <p-dropdown
          [ngClass]="{
            'invalid-dropdown': newDeviceForm.controls.brandId.invalid
          }"
          id="brand-id"
          [options]="brands"
          optionLabel="brandName"
          optionValue="id"
          placeholder="Виберіть бренд"
          formControlName="brandId"
        ></p-dropdown>
        @if (
          newDeviceForm.controls.brandId.invalid &&
          (newDeviceForm.controls.brandId.dirty ||
            newDeviceForm.controls.brandId.touched)
        ) {
          <p class="new-device__error">{{ showMessage('brandId') }}</p>
        }
      </div>
    }
    @if (categories$ | async; as categories) {
      <div class="new-device__field">
        <label class="new-device__label" for="category-id">Категорія</label>
        <p-cascadeSelect
          [ngClass]="{
            'invalid-dropdown': newDeviceForm.controls.categoryId.invalid
          }"
          id="category-id"
          [options]="categories"
          optionLabel="categoryName"
          optionValue="id"
          optionGroupLabel="categoryName"
          [optionGroupChildren]="['children', 'children']"
          placeholder="Виберіть категорію"
          formControlName="categoryId"
          (onChange)="changeValue($event)"
        >
        </p-cascadeSelect>
        @if (
          newDeviceForm.controls.categoryId.invalid &&
          (newDeviceForm.controls.categoryId.dirty ||
            newDeviceForm.controls.categoryId.touched)
        ) {
          <p class="new-device__error">{{ showMessage('categoryId') }}</p>
        }
      </div>
    }
    <div>
      <label class="new-device__label">Зображення</label>
      <input
        #input
        type="file"
        accept="image/*"
        multiple
        class="new-device__input"
        (change)="uploadFiles($event)"
      />
      <button class="new-device__upload-button" (click)="input.click()">
        Завантажити зображення
      </button>
      <div formArrayName="images" class="new-device__files">
        @for (file of files; track file; let index = $index) {
          <div class="new-device__file-wrapper">
            <div
              class="new-device__file"
              [ngClass]="{
                'new-device__file--invalid': getImagesCtrl().at(index).invalid
              }"
            >
              <app-file-control
                [file]="file"
                [control]="getImagesCtrl().at(index)"
                [formControlName]="index"
                (uploadFile)="setBase64Image($event, index)"
              ></app-file-control>
              <button
                class="new-device__delete-button"
                (click)="deleteImageCtrl(index)"
              >
                <svg-icon
                  class="new-device__icon"
                  src="assets/images/trash-bin-icon.svg"
                ></svg-icon>
              </button>
            </div>
            @if (getImagesCtrl().at(index).invalid) {
              <p class="new-device__error">
                {{ showMessageArray('images', index) }}
              </p>
            }
          </div>
        }
      </div>
    </div>
    @if (properties$ | async; as properties) {
      @if (properties.length) {
        <h3 class="new-device__title">Характеристики</h3>
      }
      <ng-container formArrayName="properties">
        @for (property of properties; track property; let index = $index) {
          <ng-container [formGroupName]="index">
            <app-input
              [label]="property.propertyName"
              [validators]="requiredValidators"
              formControlName="value"
            ></app-input>
          </ng-container>
        }
      </ng-container>
    }
  </div>
  <div class="new-device__buttons">
    <button
      class="new-device__save-button"
      [disabled]="newDeviceForm.invalid"
      (click)="saveDevice()"
    >
      Зберегти
    </button>
    <button class="new-device__cancel-button" (click)="cancelDevice()">
      Відмінити
    </button>
  </div>
</div>
